name: AI PR Summary

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

jobs:
  ai-summary:
    name: Generate AI Summary for Client
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    env:
      REPORTS_WEBHOOK: ${{ secrets.REPORT_FUNKY_UPDATES }}
      ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
    steps:
      - uses: actions/checkout@v4
        if: env.REPORTS_WEBHOOK != '' && env.ANTHROPIC_KEY != ''
        with:
          fetch-depth: 0

      - name: Get PR diff
        if: env.REPORTS_WEBHOOK != '' && env.ANTHROPIC_KEY != ''
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 50
            });

            let diffSummary = files.map(f => {
              return `File: ${f.filename} (${f.status}, +${f.additions} -${f.deletions})\nPatch:\n${(f.patch || '').substring(0, 500)}`;
            }).join('\n---\n');

            if (diffSummary.length > 8000) {
              diffSummary = diffSummary.substring(0, 8000) + '\n... (truncated)';
            }

            core.setOutput('diff', diffSummary);
            core.setOutput('file-count', files.length);
            core.setOutput('additions', files.reduce((sum, f) => sum + f.additions, 0));
            core.setOutput('deletions', files.reduce((sum, f) => sum + f.deletions, 0));

      - name: Get PR details
        if: env.REPORTS_WEBHOOK != '' && env.ANTHROPIC_KEY != ''
        id: pr
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            core.setOutput('title', pr.title);
            core.setOutput('body', (pr.body || '').substring(0, 2000));
            core.setOutput('author', pr.user.login);
            core.setOutput('url', pr.html_url);
            core.setOutput('number', pr.number);

      - name: Generate AI summary
        if: env.REPORTS_WEBHOOK != '' && env.ANTHROPIC_KEY != ''
        id: ai
        env:
          INPUT_PR_TITLE: ${{ steps.pr.outputs.title }}
          INPUT_PR_BODY: ${{ steps.pr.outputs.body }}
          INPUT_DIFF: ${{ steps.diff.outputs.diff }}
          INPUT_FILE_COUNT: ${{ steps.diff.outputs.file-count }}
          INPUT_ADDITIONS: ${{ steps.diff.outputs.additions }}
          INPUT_DELETIONS: ${{ steps.diff.outputs.deletions }}
          INPUT_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          SUMMARY=$(python3 << 'PYEOF'
          import json, os, urllib.request, urllib.error

          prompt = (
              "You are a development assistant for the FUNKY.FAN project "
              "(a gacha token/NFT platform on BSC blockchain). Generate a brief, "
              "client-friendly summary of this Smart Contract Pull Request for a "
              "non-technical client viewing Slack.\n\n"
              "Rules:\n"
              "- Write in simple, clear language (no jargon)\n"
              "- Maximum 5 bullet points\n"
              "- Focus on WHAT changed in the contract behavior and WHY\n"
              "- ALWAYS mention security implications clearly\n"
              "- Flag if this requires redeployment or migration\n"
              "- Flag if token economics are affected\n"
              "- Keep it under 300 words total\n"
              "- Do NOT use markdown headers, just plain text with bullet points\n\n"
              f"PR Title: {os.environ['INPUT_PR_TITLE']}\n"
              f"PR Description:\n{os.environ['INPUT_PR_BODY']}\n\n"
              f"Code Changes ({os.environ['INPUT_FILE_COUNT']} files, "
              f"+{os.environ['INPUT_ADDITIONS']} -{os.environ['INPUT_DELETIONS']}):\n"
              f"{os.environ['INPUT_DIFF']}"
          )

          payload = json.dumps({
              "model": "claude-sonnet-4-20250514",
              "max_tokens": 1024,
              "messages": [{"role": "user", "content": prompt}]
          })

          req = urllib.request.Request(
              "https://api.anthropic.com/v1/messages",
              data=payload.encode("utf-8"),
              headers={
                  "Content-Type": "application/json",
                  "x-api-key": os.environ["INPUT_API_KEY"],
                  "anthropic-version": "2023-06-01",
              },
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read().decode("utf-8"))
              if "content" in data and len(data["content"]) > 0:
                  print(data["content"][0]["text"])
              else:
                  print("AI summary unavailable")
          except urllib.error.HTTPError as e:
              body = json.loads(e.read().decode("utf-8"))
              msg = body.get("error", {}).get("message", str(e))
              print(f"AI summary unavailable: {msg}")
          except Exception as e:
              print(f"AI summary unavailable: {e}")
          PYEOF
          )

          echo "summary<<EOF" >> $GITHUB_OUTPUT
          echo "$SUMMARY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post AI summary to Slack
        if: env.REPORTS_WEBHOOK != '' && env.ANTHROPIC_KEY != ''
        uses: slackapi/slack-github-action@v2.0.0
        with:
          webhook: ${{ secrets.REPORT_FUNKY_UPDATES }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ðŸ¤– [Contracts] AI Summary â€” PR #${{ steps.pr.outputs.number }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*<${{ steps.pr.outputs.url }}|${{ steps.pr.outputs.title }}>*\nby `${{ steps.pr.outputs.author }}`  |  ${{ steps.diff.outputs.file-count }} files  |  +${{ steps.diff.outputs.additions }} -${{ steps.diff.outputs.deletions }}"
                  }
                },
                {
                  "type": "divider"
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "${{ steps.ai.outputs.summary }}"
                  }
                },
                {
                  "type": "context",
                  "elements": [
                    {
                      "type": "mrkdwn",
                      "text": ":robot_face: repo:`Funky-Contracts` type:`ai_summary` pr:`${{ steps.pr.outputs.number }}` model:`claude-sonnet-4-20250514`"
                    }
                  ]
                }
              ]
            }
