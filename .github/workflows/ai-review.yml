name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  pull-requests: write
  contents: read

jobs:
  review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    env:
      ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
    steps:
      - uses: actions/checkout@v4
        if: env.ANTHROPIC_KEY != ''
        with:
          fetch-depth: 0

      - name: Get PR diff
        if: env.ANTHROPIC_KEY != ''
        id: diff
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              per_page: 30
            });

            let diffText = files.map(f => {
              const patch = (f.patch || '').substring(0, 2000);
              return `### ${f.filename} (${f.status}, +${f.additions} -${f.deletions})\n\`\`\`diff\n${patch}\n\`\`\``;
            }).join('\n\n');

            if (diffText.length > 14000) {
              diffText = diffText.substring(0, 14000) + '\n\n... (truncated)';
            }

            core.setOutput('diff', diffText);
            core.setOutput('file-count', files.length);
            core.setOutput('pr-title', context.payload.pull_request.title);
            core.setOutput('pr-body', (context.payload.pull_request.body || '').substring(0, 1000));

      - name: Run AI review
        if: env.ANTHROPIC_KEY != ''
        id: review
        env:
          INPUT_DIFF: ${{ steps.diff.outputs.diff }}
          INPUT_PR_TITLE: ${{ steps.diff.outputs.pr-title }}
          INPUT_PR_BODY: ${{ steps.diff.outputs.pr-body }}
          INPUT_FILE_COUNT: ${{ steps.diff.outputs.file-count }}
          INPUT_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          REVIEW=$(python3 << 'PYEOF'
          import json, os, urllib.request, urllib.error

          prompt = """You are a senior Solidity security auditor reviewing a PR for the Funky.fan platform.
This is a Hardhat project with:
- FunkyRave: ERC20 token on BSC with 8-tier holding-period fee system (3%-25%)
- FunkyNFT: ERC721 with Chainlink BNB/USD price oracle
- OpenZeppelin Contracts ^5.4.0
- Both contracts target production deployment â€” TREAT ALL FINDINGS AS HIGH STAKES

Review the following PR with extreme care for:
1. **Security** â€” Reentrancy, access control bypass, integer overflow/underflow, front-running, oracle manipulation, flash loan attacks
2. **Correctness** â€” Fee calculation errors, wrong tier boundaries, incorrect event emissions, missing checks-effects-interactions
3. **Gas optimization** â€” Unnecessary storage reads, inefficient loops, missing `unchecked` blocks
4. **Upgrade safety** â€” Storage slot collisions, initializer issues (if applicable)
5. **Deployment impact** â€” Does this require redeployment? Token migration? Config update?
6. **Test coverage** â€” Are the new code paths tested?

Verdict must be one of: `LGTM` / `NEEDS_MINOR_CHANGES` / `NEEDS_MAJOR_CHANGES` / `SECURITY_CRITICAL`

Format your response exactly like this:
## AI Review â€” [Contracts]

**Verdict:** `LGTM` | `NEEDS_MINOR_CHANGES` | `NEEDS_MAJOR_CHANGES` | `SECURITY_CRITICAL`

### Summary
(1-2 sentences about the overall change and deployment impact)

### Findings
(bullet list â€” only include if there are actual issues)
- ðŸ”´ **[CRITICAL]** description (file:line if known)
- ðŸŸ¡ **[WARNING]** description
- ðŸ”µ **[INFO]** description

### Deployment Notes
- Requires redeployment: YES/NO
- Backend impact: YES/NO
- Frontend impact: YES/NO

### Strengths
(1-3 things done well â€” always include)

---
*Reviewed by claude-sonnet-4-6 | automated â€” always conduct manual audit before mainnet deployment*

PR Title: """ + os.environ["INPUT_PR_TITLE"] + """
PR Description: """ + os.environ["INPUT_PR_BODY"] + """

Files changed (""" + os.environ["INPUT_FILE_COUNT"] + """):

""" + os.environ["INPUT_DIFF"]

          if len(prompt) > 30000:
              prompt = prompt[:30000] + "\n\n... (diff truncated)"

          payload = json.dumps({
              "model": "claude-sonnet-4-6",
              "max_tokens": 2000,
              "messages": [{"role": "user", "content": prompt}]
          })

          req = urllib.request.Request(
              "https://api.anthropic.com/v1/messages",
              data=payload.encode("utf-8"),
              headers={
                  "Content-Type": "application/json",
                  "x-api-key": os.environ["INPUT_API_KEY"],
                  "anthropic-version": "2023-06-01",
              },
          )

          try:
              with urllib.request.urlopen(req) as resp:
                  data = json.loads(resp.read().decode("utf-8"))
              print(data["content"][0]["text"])
          except urllib.error.HTTPError as e:
              body = json.loads(e.read().decode("utf-8"))
              msg = body.get("error", {}).get("message", str(e))
              print(f"AI review unavailable: {msg}")
          except Exception as e:
              print(f"AI review unavailable: {e}")
          PYEOF
          )

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post review comment on PR
        if: env.ANTHROPIC_KEY != ''
        uses: actions/github-script@v7
        with:
          script: |
            const review = `${{ steps.review.outputs.review }}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: review
            });

      - name: Notify Discord
        if: env.ANTHROPIC_KEY != '' && env.DISCORD_WEBHOOK != ''
        env:
          REVIEW_TEXT: ${{ steps.review.outputs.review }}
        run: |
          python3 << 'PYEOF'
          import json, os, urllib.request

          review = os.environ.get("REVIEW_TEXT", "")
          if "SECURITY_CRITICAL" in review:
            verdict = "SECURITY_CRITICAL"
            emoji, color = "ðŸš¨", 15158332
          elif "NEEDS_MAJOR_CHANGES" in review:
            verdict = "NEEDS_MAJOR_CHANGES"
            emoji, color = "ðŸ”´", 15158332
          elif "NEEDS_MINOR_CHANGES" in review:
            verdict = "NEEDS_MINOR_CHANGES"
            emoji, color = "ðŸŸ¡", 15844367
          else:
            verdict = "LGTM"
            emoji, color = "ðŸŸ¢", 3066993

          summary_lines = [l for l in review.split("\n") if l.strip() and not l.startswith("#") and not l.startswith("*")]
          snippet = "\n".join(summary_lines[:6])[:800]

          content = "@here" if verdict in ("SECURITY_CRITICAL", "NEEDS_MAJOR_CHANGES") else ""

          payload = {
            "content": content,
            "username": "Funky Bot",
            "embeds": [{
              "title": f"{emoji} [Contracts] AI Review: {verdict}",
              "url": "https://github.com/${{ github.repository }}/pull/${{ github.event.pull_request.number }}",
              "description": f"**PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}**\n\n{snippet}",
              "color": color,
              "footer": {"text": "repo:Funky-Contracts  type:ai_review  model:claude-sonnet-4-6"}
            }]
          }

          req = urllib.request.Request(
            os.environ["DISCORD_WEBHOOK"],
            data=json.dumps(payload).encode("utf-8"),
            headers={"Content-Type": "application/json"},
            method="POST"
          )
          urllib.request.urlopen(req)
          PYEOF
